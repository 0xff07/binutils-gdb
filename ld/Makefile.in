# Makefile for the GNU linker ld (version 2)
# Copyright (C) 1989-1992 Free Software Foundation, Inc.

# This file is part of GNU ld..

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.


srcdir = .

prefix = /usr/local

program_prefix =
program_suffix =
exec_prefix = $(prefix)
bindir = $(exec_prefix)/bin
libdir = $(exec_prefix)/lib
tooldir = $(bindir)
datadir = $(prefix)/lib
mandir = $(prefix)/man
man1dir = $(mandir)/man1
man2dir = $(mandir)/man2
man3dir = $(mandir)/man3
man4dir = $(mandir)/man4
man5dir = $(mandir)/man5
man6dir = $(mandir)/man6
man7dir = $(mandir)/man7
man8dir = $(mandir)/man8
man9dir = $(mandir)/man9
infodir = $(prefix)/info
includedir = $(prefix)/include
docdir = $(datadir)/doc

gcclibdir = $(libdir)/gcc/$(target_alias)

SHELL = /bin/sh

INSTALL = install -c
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL)
AR = ar
AR_FLAGS = qv
CFLAGS = -g
MAKEINFO = makeinfo
RANLIB = ranlib
HOST_CC=$(CC)
BISON = `if [ -f ../bison/bison ] ; then echo ../bison/bison -y -L../bison/bison ; else echo bison -y ; fi`
LEX = `if [ -f ../flex/flex ] ; then echo ../flex/flex -S../flex/flex.skel ; else echo flex ; fi`

#version=/`./../gcc/gcc -dumpversion`
version=

# Seach path to override the default search path for -lfoo libraries.
# If LIB_PATH is empty, the ones in the script (if any) are left alone.
# (The default is usually /lib:usr/lib:/usr/local/lib, unless building
# a cross-linker, in which case the default is empty.  See genscripts.sh.)
# Otherwise, they are replaced with the ones given in LIB_PATH,
# which may have the form: LIB_PATH=/lib:/usr/local/lib
LIB_PATH =

BASEDIR	= ../..
INCLUDE	= $(srcdir)/../include
INCLUDES = -I. -I$(srcdir)  -I$(INCLUDE) 

# Where to find texinfo.tex to format docn with TeX
TEXIDIR = $(srcdir)/../texinfo/fsf

# Whether to get roff to put indexing entries on stderr
TEXI2OPT =
# You neeed this to generate ld-index.ms (or .mm or .me)
# TEXI2OPT = -i

TEXI2ROFF=texi2roff

# Which roff program to use to generate index for texi2roff'd doc
ROFF = groff

#stuff for self hosting (can be overridden in config file).
HOSTING_CRT0=/lib/crt0.o
HOSTING_LIBS=`if [ -f ../gcc/libgcc.a ] ; then echo ../gcc/libgcc.a ; else echo $(libdir)/libgcc.a; fi`  -lc
HOSTING_EMU=LDEMULATION=$(EMUL); export LDEMULATION

C++ = g++ -fgnu-linker

### Host, target, and site specific Makefile fragments come in here.
###

LINTFLAGS =  $(INCLUDES) $(EXTRA_DEF) 

.SUFFIXES: .y .x .xr .xu .xn .xbn .sc .scu .scr .scn $(SUFFIXES) .cc

.c.o:
	$(CC) -c $(CFLAGS) $(INCLUDES) $(HDEFINES) $(TDEFINES) $(CDEFINES) $<

.cc.o:
	$(C++) -c $(CFLAGS) -I$(srcdir) $<

# go directly to ld.new in case this ld isn't capable of
# linking native object on this host.  It can be renamed on
# install.
LD_PROG	= ld.new

# for self hosting
BFDLIB=./../bfd/libbfd.a
LIBIBERTY=./../libiberty/libiberty.a

ALL_EMULATIONS=ld__lnk960.o ld__sun3.o ld__i386aout.o \
	ld__go32.o ld__m88kbcs.o ld__a29k.o ld__news.o ld__hp300bsd.o ld__h8300hms.o ld__ebmon29k.o \
	ld__sun4.o ld__gld960.o ld__vanilla.o ld__h8300xray.o ld__st2000.o ld__sa29200.o

EMULATION_OFILES=${ALL_EMULATIONS}
#EMULATION_OFILES=ld__${EMUL}.o ${OTHER_EMULATIONS}

OFILES= ldgram.o ldlex.o lexsup.o ldlang.o mri.o ldctor.o ldmain.o ldindr.o \
	ldwarn.o ldwrite.o ldexp.o  ldemul.o ldver.o ldmisc.o ldsym.o \
	ldfile.o relax.o  lderror.o cplus-dem.o ${EMULATION_OFILES}

HEADERS=config.h ldmain.h ldmain.h ldwarn.h ldmisc.h ldindr.h \
	ldsym.h ldctor.h ldlang.h ldexp.h \
	ldlex.h ldwrite.h ldver.h ldemul.h ldfile.h ldgram.h ld.h

MANSOURCES=ld.tex

LDCSOURCES=ldlang.c lexsup.c ldctor.c mri.c ldindr.c ldmain.c ldwrite.c ldwarn.c ldlnk960.c \
	ld__gld.c ld__sun3.c ld__go32.c ld__m88k.c ld__ebmon29k.c \
	ldgld960.c ldemul.c ldver.c ldmisc.c ldexp.c ldsym.c ldfile.c \
	relax.c  lderror.c cplus-dem.c

GENERATED_SOURCES=ldgram.c ldlex.c ld__*.c ldemul-list.h
GENERATED_HEADERS=ldgram.h ldemul-list.h

LDSOURCES=$(LDCSOURCES) ldgram.y ldlex.l ldgram.h

BFDSOURCES=../../bfd/common/*.c

SOURCES= $(LDSOURCES) $(BFDSOURCES)
LINTSOURCES=   $(LDCSOURCES) $(BFDSOURCES) $(GENERATED_SOURCES)

STAGESTUFF = *.x *.x[runN] *.sc[runN] $(GENERATED_SOURCES) $(GENERATED_HEADERS) $(OFILES) $(LD_PROG) mkscript

all: Makefile $(LD_PROG)

check: bootstrap check-cdtest
info: ld.info

ldgram.h ldgram.c: ldgram.y
	$(BISON) $(BISONFLAGS) -d $(srcdir)/ldgram.y
	mv -f y.tab.c ldgram.c
	mv -f y.tab.h ldgram.h

ldmain.o: ldmain.c
	$(CC) $(CFLAGS) $(INCLUDES) $(HDEFINES) $(TDEFINES) $(CDEFINES) -DDEFAULT_EMULATION='"$(EMUL)"' -c $<

ldemul-list.h:  Makefile
	(echo "/* This file is automatically generated.  DO NOT EDIT! */";\
	for f in `echo " " ${EMULATION_OFILES} "" \
	 | sed -e 's/ld__/ld/g' -e 's/ ld/ /g' -e 's/[.]o//g'`; do \
	    echo "extern ld_emulation_xfer_type ld_$${f}_emulation;"; \
	done;\
	echo "";\
	echo "#define EMULATION_LIST \\";\
	for f in `echo " " ${EMULATION_OFILES} "" \
	 | sed -e 's/ld__/ld/g' -e 's/ ld/ /g' -e 's/[.]o//g'`; do \
	    echo "  &ld_$${f}_emulation, \\"; \
	done;\
	echo "  0") >ldemul-list.h

ldemul.o: ldemul-list.h

ldlex.c: ldlex.l
	$(LEX) -I -Cem $(srcdir)/ldlex.l
	mv lex.yy.c ldlex.c

# These all start with ld__ so 'make clean' can find them.

GENSCRIPTS=sh $(srcdir)/genscripts.sh ${srcdir} ${host_alias} ${target_alias}
GEN_DEPENDS=./mkscript $(srcdir)/genscripts.sh

ld__sun4.c: $(srcdir)/sun4.sh \
  $(srcdir)/generic.em $(srcdir)/aout.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} sun4.sh
ld__sun3.c: $(srcdir)/sun3.sh \
  $(srcdir)/generic.em $(srcdir)/aout.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} sun3.sh
ld__go32.c: $(srcdir)/go32.sh \
  $(srcdir)/generic.em $(srcdir)/aout.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} go32.sh
ld__news.c: $(srcdir)/news.sh \
  $(srcdir)/generic.em $(srcdir)/aout.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} news.sh
ld__hp300bsd.c: $(srcdir)/hp300bsd.sh \
  $(srcdir)/generic.em $(srcdir)/aout.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} hp300bsd.sh
ld__i386aout.c: $(srcdir)/i386aout.sh \
  $(srcdir)/generic.em $(srcdir)/aout.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} i386aout.sh
ld__ebmon29k.c: $(srcdir)/ebmon29k.sh \
  $(srcdir)/generic.em $(srcdir)/ebmon29k.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} ebmon29k.sh
ld__sa29200.c: $(srcdir)/sa29200.sh \
  $(srcdir)/generic.em $(srcdir)/sa29200.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} sa29200.sh
ld__a29k.c: $(srcdir)/a29k.sh \
  $(srcdir)/generic.em $(srcdir)/a29k.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} a29k.sh
ld__m88kbcs.c: $(srcdir)/m88kbcs.sh \
  $(srcdir)/generic.em $(srcdir)/h8300hms.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} m88kbcs.sh
ld__h8300hms.c: $(srcdir)/h8300hms.sh \
  $(srcdir)/h8300hms.em $(srcdir)/h8300hms.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} h8300hms.sh
ld__h8300xray.c: $(srcdir)/h8300xray.sh \
  $(srcdir)/h8300xray.em $(srcdir)/h8300xray.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} h8300xray.sh
ld__st2000.c: $(srcdir)/st2000.sh \
  $(srcdir)/st2000.em $(srcdir)/st2000.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} st2000.sh
ld__vanilla.c: $(srcdir)/vanilla.sh \
  $(srcdir)/vanilla.em $(srcdir)/vanilla.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} vanilla.sh
ld__lnk960.c: $(srcdir)/lnk960.sh \
  $(srcdir)/lnk960.em $(srcdir)/i960.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} lnk960.sh
ld__gld960.c: $(srcdir)/gld960.sh \
  $(srcdir)/gld960.em $(srcdir)/i960.sc-sh ${GEN_DEPENDS}
	${GENSCRIPTS} gld960.sh

$(LD_PROG): $(OFILES) $(BFDLIB) $(LIBIBERTY)
	$(CC) $(CFLAGS) $(INCLUDES) $(HDEFINES) $(TDEFINES) $(CDEFINES) $(LDFLAGS) -o $(LD_PROG) $(OFILES) $(BFDLIB) $(LIBIBERTY) $(LOADLIBES)

# Rules for testing by relinking ld itself.

ld-partial.o: ld.new
	$(HOSTING_EMU); ./ld.new -o ld-partial.o -r $(OFILES)
ld1: ld-partial.o
	$(HOSTING_EMU); ./ld.new -o ld1 $(HOSTING_CRT0) ld-partial.o $(BFDLIB) $(LIBIBERTY) $(HOSTING_LIBS)

ld1-full: ld.new
	$(HOSTING_EMU); ./ld.new -o ld1-full $(HOSTING_CRT0) $(OFILES) $(BFDLIB) $(LIBIBERTY) $(HOSTING_LIBS)

ld2: ld1
	$(HOSTING_EMU); ./ld1 -o ld2 $(HOSTING_CRT0) $(OFILES) $(BFDLIB) $(LIBIBERTY) $(HOSTING_LIBS)

ld3: ld2
	$(HOSTING_EMU); ./ld2 -o ld3 $(HOSTING_CRT0) $(OFILES) $(BFDLIB) $(LIBIBERTY) $(HOSTING_LIBS)

bootstrap: ld3
	cmp ld2 ld3

cdtest: cdtest-main.o cdtest-func.o cdtest-foo.o
	$(HOSTING_EMU); ./ld.new -o cdtest $(HOSTING_CRT0) \
	  cdtest-main.o cdtest-func.o cdtest-foo.o $(HOSTING_LIBS)

check-cdtest: cdtest $(srcdir)/cdtest.exp
	./cdtest >cdtest.out
	diff $(srcdir)/cdtest.exp cdtest.out

######################################################################
# DOCUMENTATION TARGETS
# TeX output
ld.dvi: $(srcdir)/ld.texinfo
	TEXINPUTS=${TEXIDIR}:.:$$TEXINPUTS tex $(srcdir)/ld.texinfo
	texindex ld.??
	TEXINPUTS=${TEXIDIR}:.:$$TEXINPUTS tex $(srcdir)/ld.texinfo
ldint.dvi: $(srcdir)/ldint.texinfo
	TEXINPUTS=${TEXIDIR}:.:$$TEXINPUTS tex $(srcdir)/ldint.texinfo
	texindex ldint.??
	TEXINPUTS=${TEXIDIR}:.:$$TEXINPUTS tex $(srcdir)/ldint.texinfo

# info file for online browsing
ld.info: $(srcdir)/ld.texinfo
	$(MAKEINFO) -o ld.info $(srcdir)/ld.texinfo

ldint.info: $(srcdir)/ldint.texinfo
	$(MAKEINFO) -o ldint.info $(srcdir)/ldint.texinfo

#separate targets for "ms", "me", and "mm" forms of roff doc
# Try to use a recent texi2roff.  v2 was put on prep in jan91.
# If you want an index, see texi2roff doc for postprocessing 
# and add -i to texi2roff invocations below.
# Workarounds for texi2roff-2 (probably fixed in later texi2roff's, delete
#    correspondint -e lines when later texi2roff's are current)
# + @ifinfo's deleted explicitly due to texi2roff-2 bug w nested constructs.
# + @c's deleted explicitly because texi2roff sees texinfo commands in them
# + @   (that's at-BLANK) not recognized by texi2roff, turned into blank
# + @alphaenumerate is ridiculously new, turned into @enumerate

ld.ms: $(srcdir)/ld.texinfo
	sed -e '/\\input texinfo/d' \
		-e '/@c TEXI2ROFF-KILL/,/@c END TEXI2ROFF-KILL/d' \
		-e '/^@ifinfo/,/^@end ifinfo/d' \
		-e '/^@c/d' \
		-e 's/{.*,,/{/' \
		-e 's/@ / /g' \
		-e 's/^@alphaenumerate/@enumerate/g' \
		-e 's/^@end alphaenumerate/@end enumerate/g' \
		$(srcdir)/ld.texinfo | \
	$(TEXI2ROFF) $(TEXI2OPT) -ms | \
	sed -e 's/---/\\(em/g' \
		>>ld.ms 

# index for roff output
ld-index.ms: ld.ms
	$(ROFF) -ms ld.ms 2>&1 1>/dev/null | \
		sed -e '/: warning:/d' | \
		texi2index >ld-index.ms

# roff output (-mm)
ld.mm: $(srcdir)/ld.texinfo
	sed -e '/\\input texinfo/d' \
		-e '/@c TEXI2ROFF-KILL/,/@c END TEXI2ROFF-KILL/d' \
		-e '/^@ifinfo/,/^@end ifinfo/d' \
		-e '/^@c/d' \
		-e 's/{.*,,/{/' \
		-e '/@noindent/d' \
		-e 's/@ / /g' \
		-e 's/^@alphaenumerate/@enumerate/g' \
		-e 's/^@end alphaenumerate/@end enumerate/g' \
		$(srcdir)/ld.texinfo | \
	$(TEXI2ROFF) $(TEXI2OPT) -mm | \
	sed -e 's/---/\\(em/g' \
	>ld.mm 

# index for roff output
ld-index.mm: ld.mm
	$(ROFF) -mm ld.mm 2>&1 1>/dev/null | \
		sed -e '/: warning:/d' | \
		texi2index >ld-index.mm

# roff output (-me)
ld.me: $(srcdir)/ld.texinfo
	sed -e '/\\input texinfo/d' \
		-e '/@c TEXI2ROFF-KILL/,/@c END TEXI2ROFF-KILL/d' \
		-e '/^@ifinfo/,/^@end ifinfo/d' \
		-e '/^@c/d' \
		-e 's/{.*,,/{/' \
		-e 's/@ / /g' \
		-e 's/^@alphaenumerate/@enumerate/g' \
		-e 's/^@end alphaenumerate/@end enumerate/g' \
		$(srcdir)/ld.texinfo | \
	$(TEXI2ROFF) $(TEXI2OPT) -me | \
	sed -e 's/---/\\(em/g' \
		>>ld.me 

# index for roff output
ld-index.me: ld.me
	$(ROFF) -me ld.me 2>&1 1>/dev/null | \
		sed -e '/: warning:/d' | \
		texi2index >ld-index.me


######################################################################

./mkscript: $(srcdir)/mkscript.c
	$(HOST_CC)  -o mkscript $(srcdir)/mkscript.c 

ldlex.c: ldlex.l ldgram.h
ldlex.o: ldlex.c ldgram.h
ldgram.o: ldgram.c
ldgram.c:ldgram.y

h8300hms.o:h8300hms.c
h8300xray.o:h8300xray.c
st2000.o:st2000.c

stage1:	force
	-mkdir stage1
	-mv -f $(STAGESTUFF) stage1
	-(cd stage1 ; ln -s $(LD_PROG) ld)

stage2:	force
	-mkdir stage2
	-mv -f $(STAGESTUFF) stage2
	-(cd stage2 ; ln -s $(LD_PROG) ld)

stage3:	force
	-mkdir stage3
	-mv -f $(STAGESTUFF) stage3
	-(cd stage3 ; ln -s $(LD_PROG) ld)

against=stage2

comparison: force
	for i in $(STAGESTUFF) ; do cmp $$i $(against)/$$i ; done

de-stage1: force
	-(cd stage1 ; mv -f * ..)
	-rm ld
	-rmdir stage1

de-stage2: force
	-(cd stage2 ; mv -f * ..)
	-rm ld
	-rmdir stage2

de-stage3: force
	-(cd stage3 ; mv -f * ..)
	-rm ld
	-rmdir stage3

clean:
	-rm -f TAGS $(STAGESTUFF)
	-rm -f ld.?? ld.??? ldlex.[qp]
	-rm -f ld ld1 ld2 ld3 *.o y.output cdtest cdtest.out

lintlog:$(SOURCES) Makefile
	$(LINT) -abhxzn  $(LINTFLAGS)  $(LINTSOURCES) \
| grep -v "pointer casts may be troublesome" \
| grep -v "possible pointer alignment problem" \
| grep -v "ignore" \
| grep -v "conversion from long may lose accuracy" \
| grep -v "warning: constant argument to NOT" \
| grep -v "enumeration type clash, operator CAST" \
| grep -v "warning: constant in conditional context"\
| grep -v "archive\.c"


tags TAGS:$(SOURCES) $(HEADERS)
	etags -t $?


objdump:objdump.c 

.PHONY: install
install: $(LD_PROG)
	-rm -f $(bindir)/$(program_prefix)ld$(program_suffix)
	$(INSTALL_PROGRAM) ld.new $(bindir)/$(program_prefix)ld$(program_suffix)
	-rm -f $(tooldir)/ld
	if [ -d $(tooldir) ]; then $(INSTALL_PROGRAM) ld.new $(tooldir)/ld; else true; fi
	-rm -f $(man1dir)/$(program_prefix)ld$(program_suffix).1
	$(INSTALL_DATA) $(srcdir)/gld.1 $(man1dir)/$(program_prefix)ld$(program_suffix).1

install-info: info
	for i in ld.info* ; do \
		$(INSTALL_DATA) $$i $(infodir)/$$i ; \
	done

clean-info:
	-rm -rf *.info*

#-----------------------------------------------------------------------------
#		'STANDARD' GNU/960 TARGETS BELOW THIS POINT
#
# 'VERSION' file must be present and contain a string of the form "x.y"
#-----------------------------------------------------------------------------

ver960.c: FORCE
	rm -f ver960.c
	echo "char ${TARG}_ver[]= \"${TARG} `cat VERSION`, `date`\";" > ver960.c


# This target should be invoked before building a new release.
# 'VERSION' file must be present and contain a string of the form "x.y"
#
roll:
	@V=`cat VERSION`		; \
	MAJ=`sed 's/\..*//' VERSION`	; \
	MIN=`sed 's/.*\.//' VERSION`	; \
	V=$$MAJ.`expr $$MIN + 1`	; \
	rm -f VERSION			; \
	echo $$V >VERSION		; \
	echo Version $$V


dep: $(LDSOURCES)
	mkdep $(CFLAGS) $?

# Dummy target to force execution of dependent targets.
#
force:

# Target to uncomment host-specific lines in this makefile.  Such lines must
# have the following string beginning in column 1: #__<hostname>__#
# Original Makefile is backed up as 'Makefile.old'.
#
# Invoke with:  make make HOST=xxx
#
make:
	-@if test $(HOST)x = x ; then \
		echo 'Specify "make make HOST=???"'; \
		exit 1; \
	fi ; \
	grep -s "^#The next line was generated by 'make make'" Makefile; \
	if test $$? = 0 ; then	\
		echo "Makefile has already been processed with 'make make'";\
		exit 1; \
	fi ; \
	mv -f Makefile Makefile.old; \
	echo "#The next line was generated by 'make make'"	 >Makefile ; \
	echo "HOST=$(HOST)"					>>Makefile ; \
	echo							>>Makefile ; \
	sed "s/^#__$(HOST)__#//" < Makefile.old			>>Makefile

#

Makefile: $(srcdir)/Makefile.in $(host_makefile_frag) $(target_makefile_frag)
	$(SHELL) ./config.status

### mode:fundamental ***
### Local Variables: ***
### page-delimiter: "^#" ***
### End: ***
### end of file


# IF YOU PUT ANYTHING HERE IT WILL GO AWAY
