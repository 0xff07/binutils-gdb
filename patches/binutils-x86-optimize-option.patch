From c0b8fd4b7180ab987555e2fd810e5b0bb0ba7357 Mon Sep 17 00:00:00 2001
From: "H.J. Lu" <hjl.tools@gmail.com>
Date: Mon, 26 Feb 2018 13:40:56 -0800
Subject: [PATCH] gas: Add --with-optimization=OPTION

x86 assembler supports -O/-O2/-Os command-line options to select shorter
alternate encodings.  This patch allows the default optimization type to
be adjusted at configure time.

	* configure.ac: Add --with-optimization=OPTION.
	(DEFAULT_OPTIMIZATION): New AC_DEFINE_UNQUOTED for
	--with-optimization=OPTION.
	* config.in: Regenerated.
	* configure: Likewise.
	* config/tc-i386.c (optimize_for_space): Initialize to -1.
	(md_begin): Set optimize and optimize_for_space if
	optimize_for_space < 0.
---
 gas/config.in        |  3 +++
 gas/config/tc-i386.c | 36 +++++++++++++++++++++++++++++++++++-
 gas/configure        | 24 ++++++++++++++++++++++++
 gas/configure.ac     | 20 ++++++++++++++++++++
 4 files changed, 82 insertions(+), 1 deletion(-)

diff --git a/gas/config.in b/gas/config.in
index 60bfcc93e7..4c7578eb8b 100644
--- a/gas/config.in
+++ b/gas/config.in
@@ -50,6 +50,9 @@
 /* Define to 1 if you want to generate x86 relax relocations by default. */
 #undef DEFAULT_GENERATE_X86_RELAX_RELOCATIONS
 
+/* Define default optimization. */
+#undef DEFAULT_OPTIMIZATION
+
 /* Supported emulations. */
 #undef EMULATIONS
 
diff --git a/gas/config/tc-i386.c b/gas/config/tc-i386.c
index cd53fa46f6..b1f2ba659a 100644
--- a/gas/config/tc-i386.c
+++ b/gas/config/tc-i386.c
@@ -609,7 +609,7 @@ static int optimize = 0;
    3. Above plus optimize "test{q,l,w} $imm8,%r{64,32,16}" to
       "testb $imm7,%r8".
  */
-static int optimize_for_space = 0;
+static int optimize_for_space = -1;
 
 /* Register prefix used for error message.  */
 static const char *register_prefix = "%";
@@ -2903,6 +2903,40 @@ md_begin (void)
       x86_dwarf2_return_column = 8;
       x86_cie_data_alignment = -4;
     }
+
+  if (optimize_for_space < 0)
+    {
+      optimize = 0;
+      optimize_for_space = 0;
+#ifdef DEFAULT_OPTIMIZATION
+      {
+	/* Set default optimization from DEFAULT_OPTIMIZATION.  */
+	const char *default_optimization = DEFAULT_OPTIMIZATION;
+	if (*default_optimization == '-')
+	  default_optimization++;
+	if (*default_optimization == 'O')
+	  {
+	    default_optimization++;
+	    if (*default_optimization == 's')
+	      {
+		optimize_for_space = 1;
+		/* Turn on all encoding optimizations.  */
+		optimize = -1;
+	      }
+	    else
+	      {
+		/* Turn off -Os.  */
+		optimize_for_space = 0;
+
+		if (*default_optimization != '\0')
+		  optimize = atoi (default_optimization);
+		else
+		  optimize = 0;
+	      }
+	  }
+      }
+#endif
+    }
 }
 
 void
diff --git a/gas/configure b/gas/configure
index ea6b3b16a8..a9d26a43dc 100755
--- a/gas/configure
+++ b/gas/configure
@@ -775,6 +775,7 @@ enable_generate_build_notes
 enable_werror
 enable_build_warnings
 with_cpu
+with_optimization
 enable_nls
 enable_maintainer_mode
 with_system_zlib
@@ -1444,6 +1445,9 @@ Optional Packages:
   --with-gnu-ld           assume the C compiler uses GNU ld [default=no]
   --with-cpu=CPU          default cpu variant is CPU (currently only supported
                           on ARC)
+  --with-optimization=OPTION
+                          default optimization is OPTION (currently only
+                          supported on x86)
   --with-system-zlib      use installed libz
 
 Some influential environment variables:
@@ -11935,6 +11939,15 @@ _ACEOF
 fi
 
 
+# PR gas/22871
+# Provide a configure time option to override our default.
+ac_default_optimization=unset
+
+# Check whether --with-optimization was given.
+if test "${with_optimization+set}" = set; then :
+  withval=$with_optimization; ac_default_optimization=$with_optimization
+fi
+
 # PR 14072
 
 
@@ -12679,6 +12692,17 @@ cat >>confdefs.h <<_ACEOF
 _ACEOF
 
 
+if test ${ac_default_optimization} = unset; then
+  ac_default_optimization=no
+fi
+if test ${ac_default_optimization} != no; then
+
+cat >>confdefs.h <<_ACEOF
+#define DEFAULT_OPTIMIZATION "$ac_default_optimization"
+_ACEOF
+
+fi
+
 if test ${ac_default_elf_stt_common} = unset; then
   ac_default_elf_stt_common=0
 fi
diff --git a/gas/configure.ac b/gas/configure.ac
index a639422026..12888d2687 100644
--- a/gas/configure.ac
+++ b/gas/configure.ac
@@ -132,6 +132,18 @@ AC_ARG_WITH(cpu,
                                 [Target specific CPU.])],
             [])
 
+# PR gas/22871
+dnl Option --with-optimization=OPTION allows configure-time control of the
+dnl default optimization type within the assembler.  Currently only the
+dnl x88 target supports this feature, but others may be added in the
+dnl future.
+# Provide a configure time option to override our default.
+ac_default_optimization=unset
+AC_ARG_WITH(optimization,
+	    AS_HELP_STRING([--with-optimization=OPTION],
+            [default optimization is OPTION (currently only supported on x86)]),
+ac_default_optimization=$with_optimization)dnl
+
 # PR 14072
 AH_VERBATIM([00_CONFIG_H_CHECK],
 [/* Check that config.h is #included before system headers
@@ -602,6 +614,14 @@ AC_DEFINE_UNQUOTED(DEFAULT_GENERATE_X86_RELAX_RELOCATIONS,
   $ac_default_x86_relax_relocations,
   [Define to 1 if you want to generate x86 relax relocations by default.])
 
+if test ${ac_default_optimization} = unset; then
+  ac_default_optimization=no
+fi
+if test ${ac_default_optimization} != no; then
+  AC_DEFINE_UNQUOTED(DEFAULT_OPTIMIZATION, "$ac_default_optimization",
+    [Define default optimization.])
+fi
+
 if test ${ac_default_elf_stt_common} = unset; then
   ac_default_elf_stt_common=0
 fi
-- 
2.14.3

