From f08b26476e8fdee309cf73ddaf6e50206212d49d Mon Sep 17 00:00:00 2001
From: "H.J. Lu" <hjl.tools@gmail.com>
Date: Fri, 26 Apr 2019 11:46:36 -0700
Subject: [PATCH 2/3] ld tests: Add -z noprefer-min-page-size

---
 ld/testsuite/ld-elf/commonpage1.d | 2 +-
 ld/testsuite/ld-elf/commonpage2.d | 2 +-
 ld/testsuite/ld-elf/loadaddr1.d   | 2 +-
 ld/testsuite/ld-elf/loadaddr2.d   | 2 +-
 ld/testsuite/ld-elf/maxpage1.d    | 2 +-
 ld/testsuite/ld-elf/maxpage2.d    | 2 +-
 ld/testsuite/ld-elf/maxpage3a.d   | 2 +-
 ld/testsuite/ld-elf/maxpage3b.d   | 2 +-
 ld/testsuite/ld-elf/maxpage3c.d   | 2 +-
 ld/testsuite/ld-elf/maxpage4.d    | 2 +-
 ld/testsuite/ld-elf/maxpage5.d    | 2 +-
 ld/testsuite/ld-elf/noload-2.d    | 2 +-
 ld/testsuite/ld-elf/pr19162.d     | 2 +-
 ld/testsuite/ld-elf/textaddr1.d   | 2 +-
 ld/testsuite/ld-elf/textaddr2.d   | 2 +-
 ld/testsuite/ld-elf/textaddr4.d   | 2 +-
 ld/testsuite/ld-elf/textaddr6.d   | 2 +-
 ld/testsuite/ld-x86-64/pr14207.d  | 2 +-
 ld/testsuite/ld-x86-64/x86-64.exp | 6 ++++++
 19 files changed, 24 insertions(+), 18 deletions(-)

diff --git a/ld/testsuite/ld-elf/commonpage1.d b/ld/testsuite/ld-elf/commonpage1.d
index e3f5037e5c..a182aac0f8 100644
--- a/ld/testsuite/ld-elf/commonpage1.d
+++ b/ld/testsuite/ld-elf/commonpage1.d
@@ -1,5 +1,5 @@
 #source: maxpage1.s
-#ld: -z max-page-size=0x200000 -z common-page-size=0x100000
+#ld: -z noprefer-min-page-size -z max-page-size=0x200000 -z common-page-size=0x100000
 #readelf: -l --wide
 #target: *-*-linux* *-*-gnu* arm*-*-uclinuxfdpiceabi
 
diff --git a/ld/testsuite/ld-elf/commonpage2.d b/ld/testsuite/ld-elf/commonpage2.d
index e4d582bef6..9fcba38b6a 100644
--- a/ld/testsuite/ld-elf/commonpage2.d
+++ b/ld/testsuite/ld-elf/commonpage2.d
@@ -1,6 +1,6 @@
 #source: maxpage1.s
 #as: --32
-#ld: -z max-page-size=0x200000 -z common-page-size=0x100000 -T maxpage4.t
+#ld: -z noprefer-min-page-size -z max-page-size=0x200000 -z common-page-size=0x100000 -T maxpage4.t
 #readelf: -l --wide
 #target: x86_64-*-linux*
 
diff --git a/ld/testsuite/ld-elf/loadaddr1.d b/ld/testsuite/ld-elf/loadaddr1.d
index 0e38b64cdc..85446d62d4 100644
--- a/ld/testsuite/ld-elf/loadaddr1.d
+++ b/ld/testsuite/ld-elf/loadaddr1.d
@@ -1,5 +1,5 @@
 #source: loadaddr.s
-#ld: -T loadaddr1.t -T loadaddr.t -z max-page-size=0x200000 -z noseparate-code
+#ld: -T loadaddr1.t -T loadaddr.t -z noprefer-min-page-size -z max-page-size=0x200000 -z noseparate-code
 #readelf: -l --wide
 #target: *-*-linux* *-*-gnu* arm*-*-uclinuxfdpiceabi
 
diff --git a/ld/testsuite/ld-elf/loadaddr2.d b/ld/testsuite/ld-elf/loadaddr2.d
index 5fbfa54e55..95d7a4cbcd 100644
--- a/ld/testsuite/ld-elf/loadaddr2.d
+++ b/ld/testsuite/ld-elf/loadaddr2.d
@@ -1,5 +1,5 @@
 #source: loadaddr.s
-#ld: -T loadaddr2.t -T loadaddr.t -z max-page-size=0x200000 -z noseparate-code
+#ld: -T loadaddr2.t -T loadaddr.t -z noprefer-min-page-size -z max-page-size=0x200000 -z noseparate-code
 #readelf: -l --wide
 #target: *-*-linux* *-*-gnu* arm*-*-uclinuxfdpiceabi
 
diff --git a/ld/testsuite/ld-elf/maxpage1.d b/ld/testsuite/ld-elf/maxpage1.d
index 0b7401437d..143f636749 100644
--- a/ld/testsuite/ld-elf/maxpage1.d
+++ b/ld/testsuite/ld-elf/maxpage1.d
@@ -1,5 +1,5 @@
 #source: maxpage1.s
-#ld: -z max-page-size=0x200000
+#ld: -z noprefer-min-page-size -z max-page-size=0x200000
 #readelf: -l --wide
 #target: *-*-linux* *-*-gnu* arm*-*-uclinuxfdpiceabi
 
diff --git a/ld/testsuite/ld-elf/maxpage2.d b/ld/testsuite/ld-elf/maxpage2.d
index 95b3dc2034..0120146056 100644
--- a/ld/testsuite/ld-elf/maxpage2.d
+++ b/ld/testsuite/ld-elf/maxpage2.d
@@ -1,5 +1,5 @@
 #source: maxpage1.s
-#ld: -z max-page-size=0x100000
+#ld: -z noprefer-min-page-size -z max-page-size=0x100000
 #readelf: -l --wide
 #target: *-*-linux* *-*-gnu* arm*-*-uclinuxfdpiceabi
 
diff --git a/ld/testsuite/ld-elf/maxpage3a.d b/ld/testsuite/ld-elf/maxpage3a.d
index 5faddb7fc9..a524fea2e2 100644
--- a/ld/testsuite/ld-elf/maxpage3a.d
+++ b/ld/testsuite/ld-elf/maxpage3a.d
@@ -1,5 +1,5 @@
 #source: maxpage1.s
-#ld: -z max-page-size=0x10000000 -T maxpage3.t
+#ld: -z noprefer-min-page-size -z max-page-size=0x10000000 -T maxpage3.t
 #readelf: -lS --wide
 #target: *-*-linux* *-*-gnu* arm*-*-uclinuxfdpiceabi
 
diff --git a/ld/testsuite/ld-elf/maxpage3b.d b/ld/testsuite/ld-elf/maxpage3b.d
index 62b50c9158..f66b1f5277 100644
--- a/ld/testsuite/ld-elf/maxpage3b.d
+++ b/ld/testsuite/ld-elf/maxpage3b.d
@@ -1,5 +1,5 @@
 #source: maxpage1.s
-#ld: -T maxpage3.t -z max-page-size=0x10000000
+#ld: -T maxpage3.t -z noprefer-min-page-size -z max-page-size=0x10000000
 #readelf: -lS --wide
 #target: x86_64-*-linux*
 
diff --git a/ld/testsuite/ld-elf/maxpage3c.d b/ld/testsuite/ld-elf/maxpage3c.d
index 354a8b98ea..24552fcf88 100644
--- a/ld/testsuite/ld-elf/maxpage3c.d
+++ b/ld/testsuite/ld-elf/maxpage3c.d
@@ -1,6 +1,6 @@
 #source: maxpage1.s
 #as: --32
-#ld: -m elf_i386 -z max-page-size=0x10000000 -T maxpage3.t
+#ld: -m elf_i386 -z noprefer-min-page-size -z max-page-size=0x10000000 -T maxpage3.t
 #readelf: -lS --wide
 #target: x86_64-*-linux* i?86-*-linux-gnu i?86-*-gnu*
 
diff --git a/ld/testsuite/ld-elf/maxpage4.d b/ld/testsuite/ld-elf/maxpage4.d
index a08e85660a..42700d9609 100644
--- a/ld/testsuite/ld-elf/maxpage4.d
+++ b/ld/testsuite/ld-elf/maxpage4.d
@@ -1,6 +1,6 @@
 #source: maxpage1.s
 #as: --32
-#ld: -z max-page-size=0x200000 -T maxpage4.t
+#ld: -z noprefer-min-page-size -z max-page-size=0x200000 -T maxpage4.t
 #readelf: -l --wide
 #target: x86_64-*-linux* i?86-*-linux-gnu i?86-*-gnu*
 
diff --git a/ld/testsuite/ld-elf/maxpage5.d b/ld/testsuite/ld-elf/maxpage5.d
index 9d9b57a853..f14b3b1124 100644
--- a/ld/testsuite/ld-elf/maxpage5.d
+++ b/ld/testsuite/ld-elf/maxpage5.d
@@ -1,6 +1,6 @@
 #source: maxpage5.s
 #as: --32
-#ld: -z max-page-size=0x200000 -T maxpage5.t
+#ld: -z noprefer-min-page-size -z max-page-size=0x200000 -T maxpage5.t
 #objcopy_linked_file: -R .foo
 #readelf: -l --wide
 #target: x86_64-*-linux* i?86-*-linux-gnu i?86-*-gnu*
diff --git a/ld/testsuite/ld-elf/noload-2.d b/ld/testsuite/ld-elf/noload-2.d
index d0af8d9be0..a1b6b90c03 100644
--- a/ld/testsuite/ld-elf/noload-2.d
+++ b/ld/testsuite/ld-elf/noload-2.d
@@ -1,5 +1,5 @@
 #source: noload-1.s
-#ld: -T noload-1.t -z max-page-size=0x200000
+#ld: -T noload-1.t -z noprefer-min-page-size -z max-page-size=0x200000
 #readelf: -Sl --wide
 #target: *-*-linux* *-*-gnu* arm*-*-uclinuxfdpiceabi
 
diff --git a/ld/testsuite/ld-elf/pr19162.d b/ld/testsuite/ld-elf/pr19162.d
index 218da4035c..0f7e466dee 100644
--- a/ld/testsuite/ld-elf/pr19162.d
+++ b/ld/testsuite/ld-elf/pr19162.d
@@ -1,6 +1,6 @@
 #source: pr19162a.s
 #source: pr19162b.s
-#ld: -shared -z max-page-size=0x200000 -z noseparate-code
+#ld: -shared -z noprefer-min-page-size -z max-page-size=0x200000 -z noseparate-code
 #readelf: -l --wide
 #target: *-*-linux* *-*-gnu* *-*-nacl* arm*-*-uclinuxfdpiceabi
 #xfail: hppa*-*-*
diff --git a/ld/testsuite/ld-elf/textaddr1.d b/ld/testsuite/ld-elf/textaddr1.d
index f004ea7f7d..d7dbdc31ac 100644
--- a/ld/testsuite/ld-elf/textaddr1.d
+++ b/ld/testsuite/ld-elf/textaddr1.d
@@ -1,5 +1,5 @@
 #source: maxpage1.s
-#ld: -Ttext-segment 0x7000000 -z max-page-size=0x200000 -z noseparate-code
+#ld: -Ttext-segment 0x7000000 -z noprefer-min-page-size -z max-page-size=0x200000 -z noseparate-code
 #readelf: -l --wide
 #target: *-*-linux-gnu *-*-gnu* arm*-*-uclinuxfdpiceabi
 
diff --git a/ld/testsuite/ld-elf/textaddr2.d b/ld/testsuite/ld-elf/textaddr2.d
index 73d88b0fe5..cc69065e61 100644
--- a/ld/testsuite/ld-elf/textaddr2.d
+++ b/ld/testsuite/ld-elf/textaddr2.d
@@ -1,5 +1,5 @@
 #source: maxpage1.s
-#ld: -shared -Ttext-segment 0x7000000 -z max-page-size=0x200000 -z noseparate-code
+#ld: -shared -Ttext-segment 0x7000000 -z noprefer-min-page-size -z max-page-size=0x200000 -z noseparate-code
 #readelf: -l --wide
 #target: *-*-linux-gnu *-*-gnu* arm*-*-uclinuxfdpiceabi
 
diff --git a/ld/testsuite/ld-elf/textaddr4.d b/ld/testsuite/ld-elf/textaddr4.d
index 746ec46779..da3f1d4100 100644
--- a/ld/testsuite/ld-elf/textaddr4.d
+++ b/ld/testsuite/ld-elf/textaddr4.d
@@ -1,5 +1,5 @@
 #source: maxpage1.s
-#ld: -z max-page-size=0x10000 -Ttext-segment 0x10000 -z noseparate-code
+#ld: -z noprefer-min-page-size -z max-page-size=0x10000 -Ttext-segment 0x10000 -z noseparate-code
 #readelf: -l --wide
 #target: *-*-linux-gnu *-*-gnu* arm*-*-uclinuxfdpiceabi
 
diff --git a/ld/testsuite/ld-elf/textaddr6.d b/ld/testsuite/ld-elf/textaddr6.d
index aa5cf56f48..a6ffa3709f 100644
--- a/ld/testsuite/ld-elf/textaddr6.d
+++ b/ld/testsuite/ld-elf/textaddr6.d
@@ -1,5 +1,5 @@
 #source: maxpage1.s
-#ld: -shared -z max-page-size=0x10000 -Ttext-segment 0x10000 -z noseparate-code
+#ld: -shared -z noprefer-min-page-size -z max-page-size=0x10000 -Ttext-segment 0x10000 -z noseparate-code
 #readelf: -l --wide
 #target: *-*-linux-gnu *-*-gnu* arm*-*-uclinuxfdpiceabi
 
diff --git a/ld/testsuite/ld-x86-64/pr14207.d b/ld/testsuite/ld-x86-64/pr14207.d
index 1713888ff7..4dc3e8411b 100644
--- a/ld/testsuite/ld-x86-64/pr14207.d
+++ b/ld/testsuite/ld-x86-64/pr14207.d
@@ -1,6 +1,6 @@
 #name: PR ld/14207
 #as: --64
-#ld: -melf_x86_64 -shared -z relro -z now --hash-style=sysv -z max-page-size=0x200000 -z noseparate-code
+#ld: -melf_x86_64 -shared -z relro -z now --hash-style=sysv -z noprefer-min-page-size -z max-page-size=0x200000 -z noseparate-code
 #readelf: -l --wide
 #target: x86_64-*-linux*
 
diff --git a/ld/testsuite/ld-x86-64/x86-64.exp b/ld/testsuite/ld-x86-64/x86-64.exp
index 23f202017c..e07f2dc7b2 100644
--- a/ld/testsuite/ld-x86-64/x86-64.exp
+++ b/ld/testsuite/ld-x86-64/x86-64.exp
@@ -55,6 +55,7 @@ set x86_64tests {
      {{objdump -drj.plt plt.pd}} "plt"}
     {"TLS -fpic -shared transitions"
      "-shared -melf_x86_64 --no-ld-generated-unwind-info \
+      -z noprefer-min-page-size \
       -z noseparate-code -z max-page-size=0x200000 --hash-style=sysv" ""
      "--64" {tlspic1.s tlspic2.s}
      {{readelf -WSsrl tlspic.rd} {objdump -drj.text\ -Mintel64 tlspic.dd}
@@ -62,6 +63,7 @@ set x86_64tests {
       "libtlspic.so"}
     {"TLS -fpic -shared transitions with r15 as GOT base"
      "-shared -melf_x86_64 --no-ld-generated-unwind-info \
+      -z noprefer-min-page-size \
       -z noseparate-code -z max-page-size=0x200000 --hash-style=sysv" ""
      "--64 -mrelax-relocations=yes"
      {tlspic3.s tlspic2.s}
@@ -70,6 +72,7 @@ set x86_64tests {
       "libtlspic2.so"}
     {"TLS descriptor -fpic -shared transitions"
      "-shared -melf_x86_64 --no-ld-generated-unwind-info \
+      -z noprefer-min-page-size \
       -z noseparate-code -z max-page-size=0x200000 --hash-style=sysv" ""
      "--64" {tlsdesc.s tlspic2.s}
      {{readelf -WSsrld tlsdesc.rd} {objdump -drj.text tlsdesc.dd}
@@ -79,6 +82,7 @@ set x86_64tests {
      "--64" {tlslib.s} {} "libtlslib.so"}
     {"TLS -fpic and -fno-pic exec transitions"
      "-melf_x86_64 tmpdir/libtlslib.so --no-ld-generated-unwind-info \
+      -z noprefer-min-page-size \
       -z noseparate-code -z max-page-size=0x200000 --hash-style=sysv" ""
      "--64" {tlsbinpic.s tlsbin.s}
      {{readelf -WSsrl tlsbin.rd} {objdump -drj.text tlsbin.dd}
@@ -86,6 +90,7 @@ set x86_64tests {
       "tlsbin"}
     {"TLS -fpic and -fno-pic exec transitions without PLT"
      "-melf_x86_64 tmpdir/libtlslib.so --no-ld-generated-unwind-info \
+      -z noprefer-min-page-size \
       -z noseparate-code -z max-page-size=0x200000 --hash-style=sysv" ""
      "-mrelax-relocations=yes --64" {tlsbinpic2.s tlsbin.s}
      {{readelf -WSsrl tlsbin2.rd} {objdump -drj.text tlsbin2.dd}
@@ -93,6 +98,7 @@ set x86_64tests {
       "tlsbin2"}
     {"TLS descriptor -fpic and -fno-pic exec transitions"
      "-melf_x86_64 tmpdir/libtlslib.so --no-ld-generated-unwind-info \
+      -z noprefer-min-page-size \
       -z noseparate-code -z max-page-size=0x200000 --hash-style=sysv" ""
      "--64" {tlsbindesc.s tlsbin.s}
      {{readelf -WSsrl tlsbindesc.rd} {objdump -drj.text tlsbindesc.dd}
-- 
2.20.1

